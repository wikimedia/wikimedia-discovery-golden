?"[,,]"
?ddply
date <- null
date <- NULL
date_clause <- function(date){
return(paste0(" WHERE year = ", lubridate::year(date),
" AND month = ", lubridate::month(date),
" AND day = ", lubridate::day(date), " "))
}
subquery <- date_clause(date)
if(is.null(date)) {
date <- Sys.Date() - 1
}
subquery <- date_clause(date)
query <- paste0("USE wmf;
SELECT
REGEXP_EXTRACT(uri_path, '^(/.*){1}/[0-4]{1,2}(/.*){2}\.png$', 1) AS style,
REGEXP_EXTRACT(uri_path, '^(/.*){1}/([0-9]{1,2})/.*\.png$', 2) AS zoom,
CONCAT(user_agent, client_ip) AS user_id,
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END) AS type,
COUNT(*) AS n
FROM webrequest",
subquery,
"  AND hour = 12
AND webrequest_source = 'maps'
AND http_status IN('200','304')
AND content_type = 'image/png'
GROUP BY CONCAT(user_agent, client_ip),
REGEXP_EXTRACT(uri_path, '/(osm(-intl))/.*', 1),
REGEXP_EXTRACT(uri_path, '/osm(-intl)?/([0-9]{1,2})/.*', 2),
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END);")
query <- paste0("USE wmf;
SELECT
REGEXP_EXTRACT(uri_path, '^(/.*){1}/[0-4]{1,2}(/.*){2}\.png$', 1) AS style,
REGEXP_EXTRACT(uri_path, '^(/.*){1}/([0-9]{1,2})/.*\.png$', 2) AS zoom,
CONCAT(user_agent, client_ip) AS user_id,
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END) AS type,
COUNT(*) AS n
FROM webrequest",
subquery,
"  AND hour = 12
AND webrequest_source = 'maps'
AND http_status IN('200','304')
AND content_type = 'image/png'
GROUP BY CONCAT(user_agent, client_ip),
REGEXP_EXTRACT(uri_path, '/(osm(-intl))/.*', 1),
REGEXP_EXTRACT(uri_path, '/osm(-intl)?/([0-9]{1,2})/.*', 2),
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END);")
query <- paste0("USE wmf;
SELECT
REGEXP_EXTRACT(uri_path, '^(/.*){1}/[0-4]{1,2}(/.*){2}.png$', 1) AS style,
REGEXP_EXTRACT(uri_path, '^(/.*){1}/([0-9]{1,2})/.*.png$', 2) AS zoom,
CONCAT(user_agent, client_ip) AS user_id,
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END) AS type,
COUNT(*) AS n
FROM webrequest",
subquery,
"  AND hour = 12
AND webrequest_source = 'maps'
AND http_status IN('200','304')
AND content_type = 'image/png'
GROUP BY CONCAT(user_agent, client_ip),
REGEXP_EXTRACT(uri_path, '/(osm(-intl))/.*', 1),
REGEXP_EXTRACT(uri_path, '/osm(-intl)?/([0-9]{1,2})/.*', 2),
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END);")
query
cat(query)
query <- paste0("USE wmf;
SELECT
REGEXP_EXTRACT(uri_path, '^(/.*){1}/[0-4]{1,2}(/.*){2}.png$', 1) AS style,
REGEXP_EXTRACT(uri_path, '^(/.*){1}/([0-9]{1,2})/.*.png$', 2) AS zoom,
CONCAT(user_agent, client_ip) AS user_id,
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END) AS type,
COUNT(*) AS n
FROM webrequest",
subquery,
"  AND hour = 12
AND webrequest_source = 'maps'
AND http_status IN('200','304')
AND content_type = 'image/png'
GROUP BY CONCAT(user_agent, client_ip),
REGEXP_EXTRACT(uri_path, '/(osm(-intl))/.*', 1),
REGEXP_EXTRACT(uri_path, '/osm(-intl)?/([0-9]{1,2})/.*', 2),
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END)
LIMIT 10;")
cat(query)
query <- paste0("USE wmf;
SELECT
REGEXP_EXTRACT(uri_path, '^(/.*){1}/[0-4]{1,2}(/.*){2}.png$', 1) AS style,
REGEXP_EXTRACT(uri_path, '^(/.*){1}/([0-9]{1,2})/.*.png$', 2) AS zoom,
CONCAT(user_agent, client_ip) AS user_id,
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END) AS type,
COUNT(*) AS n
FROM webrequest",
subquery,
"  AND hour = 12
AND webrequest_source = 'maps'
AND http_status IN('200','304')
AND content_type = 'image/png'
LIMIT 10
GROUP BY CONCAT(user_agent, client_ip),
REGEXP_EXTRACT(uri_path, '/(osm(-intl))/.*', 1),
REGEXP_EXTRACT(uri_path, '/osm(-intl)?/([0-9]{1,2})/.*', 2),
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END);")
cat(query)
query <- paste0("USE wmf;
SELECT
REGEXP_EXTRACT(uri_path, '^(/.*){1}/[0-4]{1,2}(/.*){2}.png$', 1) AS style,
REGEXP_EXTRACT(uri_path, '^(/.*){1}/([0-9]{1,2})/.*.png$', 2) AS zoom,
CONCAT(user_agent, client_ip) AS user_id,
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END) AS type,
COUNT(*) AS n
FROM webrequest",
subquery,
"  AND hour = 12
AND webrequest_source = 'maps'
AND http_status IN('200','304')
AND content_type = 'image/png'
GROUP BY CONCAT(user_agent, client_ip),
REGEXP_EXTRACT(uri_path, '/(osm(-intl))/.*', 1),
REGEXP_EXTRACT(uri_path, '/osm(-intl)?/([0-9]{1,2})/.*', 2),
(CASE WHEN http_status = '200' THEN 'new load' ELSE 'loaded before' END);")
cat(query)
?union
